{% extends "layout.html" %}

{% block content %}
<div class="max-w-4xl mx-auto h-[calc(100vh-120px)] flex flex-col">
    <div class="mb-4 flex items-center justify-between">
        <div>
            <a href="/student" class="text-slate-500 hover:text-indigo-600 text-sm">â† ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
            <h2 class="text-2xl font-bold text-slate-800 mt-1">âœï¸ ç¢ºèªãƒ†ã‚¹ãƒˆ: {{ assignment.title }}</h2>
        </div>
        <button id="speakResultBtn" onclick="speakGradingResult()" class="hidden bg-indigo-100 text-indigo-700 px-4 py-2 rounded-full font-bold hover:bg-indigo-200 transition flex items-center gap-2">
            ğŸ”Š æ¡ç‚¹çµæœã‚’èª­ã¿ä¸Šã’ã‚‹
        </button>
    </div>

    <div id="loadingArea" class="flex-grow flex flex-col justify-center items-center bg-white rounded-xl shadow-sm border border-slate-200">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mb-4"></div>
        <p class="text-slate-600 font-bold animate-pulse">AIå…ˆç”ŸãŒæˆæ¥­å†…å®¹ã‹ã‚‰å•é¡Œã‚’ä½œæˆä¸­...</p>
    </div>

    <div id="quizFormArea" class="hidden flex-grow bg-white rounded-xl shadow-sm border border-slate-200 overflow-y-auto p-8 custom-scrollbar">
        <p class="text-slate-500 mb-6">ä»¥ä¸‹ã®å•é¡Œã«ç­”ãˆã¦ãã ã•ã„ã€‚AIå…ˆç”ŸãŒè¨˜è¿°å†…å®¹ã‚’æ¡ç‚¹ã—ã¾ã™ã€‚</p>
        <form id="quizForm" onsubmit="submitQuiz(event)" class="space-y-8">
            <div id="questionsContainer"></div>
            <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold shadow-lg hover:bg-indigo-700 transition">
                ğŸš€ æ¡ç‚¹ã—ã¦ã‚‚ã‚‰ã†
            </button>
        </form>
    </div>

    <div id="resultArea" class="hidden flex-grow bg-white rounded-xl shadow-sm border border-slate-200 overflow-y-auto p-8 custom-scrollbar">
        <h3 class="text-xl font-bold text-indigo-600 mb-4 border-b pb-2">ğŸ‰ æ¡ç‚¹çµæœ</h3>
        <div id="gradingContent" class="prose prose-indigo max-w-none"></div>
        <div class="mt-8 text-center">
            <a href="/student" class="inline-block bg-slate-200 text-slate-700 px-6 py-3 rounded-lg font-bold hover:bg-slate-300 transition">
                ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹
            </a>
        </div>
    </div>
</div>

<script>
    const assignmentId = {{ assignment.id }};
    let quizId = null;
    let gradingResultText = "";

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å•é¡Œç”ŸæˆAPIã‚’å©ã
    document.addEventListener("DOMContentLoaded", async () => {
        try {
            const response = await fetch('/api/generate_quiz', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ assignment_id: assignmentId })
            });
            const data = await response.json();

            if (data.error) throw new Error(data.error);

            quizId = data.quiz_id;
            renderQuestions(data.questions);

        } catch (e) {
            document.getElementById('loadingArea').innerHTML = `<div class="text-center"><p class="text-red-500 font-bold mb-2">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</p><p class="text-sm text-slate-500">${e.message}</p><a href="/lesson_page/${assignmentId}" class="text-indigo-600 underline mt-4 block">æˆæ¥­ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹</a></div>`;
        }
    });

    function renderQuestions(questions) {
        const container = document.getElementById('questionsContainer');
        container.innerHTML = '';
        questions.forEach((q, index) => {
            const html = `
                <div class="bg-slate-50 p-6 rounded-lg border border-slate-200">
                    <label class="block font-bold text-slate-800 mb-3">
                        <span class="bg-indigo-600 text-white px-2 py-0.5 rounded text-sm mr-2">Q${index + 1}</span>
                        ${q.question}
                    </label>
                    <textarea name="q_${q.q_id}" rows="3" required placeholder="ã“ã“ã«å›ç­”ã‚’å…¥åŠ›..." class="w-full border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 p-3 text-sm"></textarea>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', html);
        });
        
        document.getElementById('loadingArea').classList.add('hidden');
        document.getElementById('quizFormArea').classList.remove('hidden');
    }

    async function submitQuiz(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const answers = {};
        for (let [key, value] of formData.entries()) {
            const qId = key.replace('q_', '');
            answers[qId] = value;
        }

        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
        document.getElementById('quizFormArea').innerHTML = '<div class="h-full flex flex-col justify-center items-center"><div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mb-4"></div><p class="text-indigo-600 font-bold animate-pulse">AIå…ˆç”ŸãŒæ¡ç‚¹ä¸­...</p></div>';

        try {
            const response = await fetch('/api/grade_quiz', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ quiz_id: quizId, answers: answers })
            });
            const data = await response.json();
            
            if (data.error) throw new Error(data.error);

            gradingResultText = data.result;
            
            document.getElementById('quizFormArea').classList.add('hidden');
            const resultDiv = document.getElementById('resultArea');
            resultDiv.classList.remove('hidden');
            
            const contentDiv = document.getElementById('gradingContent');
            contentDiv.innerHTML = marked.parse(data.result);
            
            // æ•°å¼ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
            if (typeof renderMathInElement === 'function') {
                renderMathInElement(contentDiv, {
                    delimiters: [{left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false}]
                });
            }
            
            // èª­ã¿ä¸Šã’ãƒœã‚¿ãƒ³è¡¨ç¤º
            document.getElementById('speakResultBtn').classList.remove('hidden');

        } catch (e) {
            alert("æ¡ç‚¹ã‚¨ãƒ©ãƒ¼: " + e.message);
        }
    }

    function speakGradingResult() {
        if(gradingResultText) speakText(gradingResultText);
    }
</script>
{% endblock %}