{% extends "layout.html" %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="mb-6 flex items-center gap-4">
        <a href="/student" class="text-indigo-600 hover:underline">â† ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹</a>
        <h2 class="text-2xl font-bold text-slate-800">ãƒ¬ãƒãƒ¼ãƒˆä½œæˆãƒ»AIæ·»å‰Š</h2>
    </div>

    <div class="grid md:grid-cols-2 gap-8 h-[calc(100vh-200px)]">
        <div class="flex flex-col h-full">
            <label class="block text-sm font-medium text-slate-700 mb-2">ãƒ¬ãƒãƒ¼ãƒˆæœ¬æ–‡ (Markdownå¯¾å¿œ)</label>
            <textarea id="reportContent" class="flex-grow w-full p-4 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 font-mono text-sm resize-none" placeholder="ã“ã“ã«ãƒ¬ãƒãƒ¼ãƒˆã‚’è¨˜è¿°ã—ã¦ãã ã•ã„..."></textarea>
            <button onclick="checkReport()" id="checkBtn" class="mt-4 w-full bg-indigo-600 text-white py-3 rounded-lg font-bold shadow-lg hover:bg-indigo-700 transition flex justify-center items-center gap-2">
                <span>ğŸ¤– AIå…ˆç”Ÿã«æ·»å‰Šã‚’ä¾é ¼ã™ã‚‹</span>
            </button>
        </div>

        <div class="flex flex-col h-full bg-white rounded-lg border border-slate-200 shadow-sm overflow-hidden">
            <div class="bg-indigo-50 px-4 py-3 border-b border-indigo-100">
                <h3 class="font-bold text-indigo-800">AIå…ˆç”Ÿã‹ã‚‰ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</h3>
            </div>
            <div id="feedbackArea" class="p-6 overflow-y-auto prose prose-indigo max-w-none text-sm h-full">
                <p class="text-slate-400 text-center mt-10">
                    å·¦å´ã«ãƒ¬ãƒãƒ¼ãƒˆã‚’æ›¸ã„ã¦ã€Œæ·»å‰Šã‚’ä¾é ¼ã™ã‚‹ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚<br>
                    Gemini 3.0 ProãŒã‚ãªãŸã®ãƒ¬ãƒãƒ¼ãƒˆã‚’å³ã—ããƒã‚§ãƒƒã‚¯ã—ã¾ã™ã€‚
                </p>
            </div>
        </div>
    </div>
</div>

<script>
async function checkReport() {
    const content = document.getElementById('reportContent').value;
    const feedbackArea = document.getElementById('feedbackArea');
    const btn = document.getElementById('checkBtn');

    if (!content.trim()) {
        alert("ãƒ¬ãƒãƒ¼ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
        return;
    }

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
    btn.disabled = true;
    btn.innerHTML = 'Thinking... (Gemini 3.0 Pro)';
    feedbackArea.innerHTML = '<div class="flex justify-center items-center h-full"><div class="animate-spin rounded-full h-10 w-10 border-b-2 border-indigo-600"></div></div>';

    try {
        const response = await fetch('/check_report', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ content: content })
        });
        
        const data = await response.json();
        
        if (data.error) {
            feedbackArea.innerHTML = `<p class="text-red-600">ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ${data.error}</p>`;
        } else {
            // Markdownã‚’HTMLã«å¤‰æ›ã—ã¦è¡¨ç¤º
            feedbackArea.innerHTML = marked.parse(data.feedback);
        }
    } catch (e) {
        feedbackArea.innerHTML = `<p class="text-red-600">é€šä¿¡ã‚¨ãƒ©ãƒ¼: ${e.message}</p>`;
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<span>ğŸ¤– å†åº¦æ·»å‰Šã‚’ä¾é ¼ã™ã‚‹</span>';
    }
}
</script>
{% endblock %}