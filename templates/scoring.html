<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIå…ˆç”Ÿ ãƒ†ã‚¹ãƒˆæ¡ç‚¹</title>
    <style>
        body { font-family: 'UD ãƒ‡ã‚¸ã‚¿ãƒ« æ•™ç§‘æ›¸ä½“ N-B', sans-serif; max-width: 800px; margin: auto; padding: 20px; background-color: #f0f2f5; box-sizing: border-box; }
        h1, h2 { text-align: center; color: #333; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); margin-bottom: 20px; }
        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ: box-sizingã‚’è¿½åŠ ã—ã€widthã‚’100%ã« */
        textarea { 
            width: 100%; 
            height: 100px; 
            padding: 10px; 
            border-radius: 5px; 
            border: 1px solid #ccc; 
            font-size: 1em; 
            margin-bottom: 10px; 
            box-sizing: border-box; /* è¿½åŠ  */
        }
        .image-upload-section { margin-bottom: 15px; border: 1px dashed #ccc; padding: 15px; border-radius: 5px; text-align: center; }
        .image-upload-section input[type="file"] { display: none; }
        .image-upload-section label { background-color: #007bff; color: white; padding: 10px 15px; border-radius: 5px; cursor: pointer; display: inline-block; margin-bottom: 10px; }
        .image-upload-section label:hover { background-color: #0056b3; }
        .image-upload-section.model-answer label { background-color: #17a2b8; }
        .image-upload-section.model-answer label:hover { background-color: #117a8b; }
        img.preview { max-width: 100%; max-height: 200px; object-fit: contain; margin-top: 10px; border: 1px solid #eee; display: none;}
        button { display: block; width: 100%; padding: 15px; border: none; background-color: #28a745; color: white; font-size: 1.2em; border-radius: 5px; cursor: pointer; }
        button:hover { background-color: #218838; }
        button:disabled { background-color: #ccc; }
        #result-area { margin-top: 20px; background-color: #f8f9fa; padding: 20px; border-radius: 8px; white-space: pre-wrap; line-height: 1.6; }
        .home-link { display: block; text-align: center; margin-top: 20px; text-decoration: none; color: #007bff; font-weight: bold;}
        
        #scoring-chat-area { display: none; margin-top: 20px; }
        #scoring-chat-log { height: 200px; border: 1px solid #ccc; overflow-y: scroll; padding: 10px; background-color: #f9f9f9; border-radius: 5px; margin-bottom: 10px; }
        #scoring-chat-area .message { margin-bottom: 10px; padding: 8px 12px; border-radius: 15px; max-width: 80%; }
        #scoring-chat-area .user-message { background-color: #dcf8c6; margin-left: auto; }
        #scoring-chat-area .model-message { background-color: #f1f0f0; white-space: pre-wrap; word-wrap: break-word; }
        #scoring-input-area { display: flex; }
        #scoring-question { flex-grow: 1; padding: 10px; border-radius: 5px; border: 1px solid #ccc; }
        #send-scoring-question-btn { width: auto; font-size: 1em; margin-left: 10px; background-color: #007bff; }

        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ: ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¯ã‚¨ãƒª */
        @media (max-width: 600px) {
            body { padding: 10px; }
            h1 { font-size: 1.5em; }
            .container { padding: 15px; }
            button { padding: 12px; }
            .image-upload-section p { font-size: 0.9em; }
            .image-upload-section label { padding: 8px 12px; }
            #scoring-question { padding: 8px; }
        }
    </style>
</head>
<body>
    <h1>ğŸ“ AIå…ˆç”Ÿ ãƒ†ã‚¹ãƒˆæ¡ç‚¹</h1>
    <div class="container">
        <h2>1. ç”Ÿå¾’ã®ãƒ†ã‚¹ãƒˆç”»åƒ (å¿…é ˆ)</h2>
        <div class="image-upload-section">
            <input type="file" id="student-test-image" accept="image/jpeg, image/png, image/gif">
            <label for="student-test-image">ç”Ÿå¾’ã®ãƒ†ã‚¹ãƒˆç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</label>
            <p>â€»å•é¡Œã¨ç”Ÿå¾’ã®ç­”ãˆãŒæ›¸ã‹ã‚ŒãŸãƒ†ã‚¹ãƒˆç”¨ç´™ã®ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚</p>
            <img id="student-image-preview" class="preview" src="#" alt="ç”Ÿå¾’ã®ç”»åƒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">
        </div>

        <h2>2. Læ¨¡ç¯„è§£ç­”ã®ç”»åƒ (ä»»æ„)</h2>
        <div class="image-upload-section model-answer">
            <input type="file" id="model-answer-image" accept="image/jpeg, image/png, image/gif">
            <label for="model-answer-image">æ¨¡ç¯„è§£ç­”ã®ç”»åƒã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</label>
            <p>â€»ä»»æ„ã§ã™ã€‚AIãŒã“ã‚Œã‚’æ­£è§£ã¨ã—ã¦æ¡ç‚¹ã—ã¾ã™ã€‚</p>
            <img id="model-answer-preview" class="preview" src="#" alt="æ¨¡ç¯„è§£ç­”ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">
        </div>

        <h2>3. è£œè¶³æƒ…å ±ï¼ˆä»»æ„ï¼‰</h2>
        <textarea id="test-questions-text" placeholder="ç”»åƒãŒä¸é®®æ˜ãªå ´åˆãªã©ã€è£œè¶³ã—ãŸã„å•é¡Œæ–‡ãŒã‚ã‚Œã°å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"></textarea>
        <textarea id="student-answers" placeholder="ç”»åƒå†…ã®æ–‡å­—ãŒèª­ã¿å–ã‚Šã«ãã„å ´åˆãªã©ã€ç”Ÿå¾’ã®ç­”ãˆã‚’è£œè¶³ã—ãŸã„å ´åˆã¯ã“ã“ã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚"></textarea>
        
        <button id="score-button" onclick="scoreTest()">æ¡ç‚¹ã‚’é–‹å§‹ã™ã‚‹</button>

        <div id="result-area" style="display:none;">
            <h2>æ¡ç‚¹çµæœ</h2>
            <p id="scoring-result">æ¡ç‚¹ä¸­...</p>
        </div>
    </div>
    
    <div class="container" id="scoring-chat-area">
        <h2>æ¡ç‚¹ã«ã¤ã„ã¦è³ªå•ã™ã‚‹</h2>
        <div id="scoring-chat-log"></div>
        <div id="scoring-input-area">
            <input type="text" id="scoring-question" placeholder="ä¾‹ï¼šã©ã†ã—ã¦2ç•ªã¯ã¾ã¡ãŒã„ãªã®ï¼Ÿ">
            <button id="send-scoring-question-btn" onclick="sendScoringQuestion()">é€ä¿¡</button>
        </div>
    </div>

    <a href="/" class="home-link">ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«æˆ»ã‚‹</a>
<script>
    let studentImageDataUrl = null;
    let modelAnswerImageDataUrl = null;
    let lastGradingResult = ""; // AIã®æ¡ç‚¹çµæœã‚’ä¿å­˜ã™ã‚‹å¤‰æ•°

    document.getElementById('student-test-image').addEventListener('change', function(event) {
        handleFileSelect(event, 'student-image-preview', (dataUrl) => {
            studentImageDataUrl = dataUrl;
        });
    });

    document.getElementById('model-answer-image').addEventListener('change', function(event) {
        handleFileSelect(event, 'model-answer-preview', (dataUrl) => {
            modelAnswerImageDataUrl = dataUrl;
        });
    });

    function handleFileSelect(event, previewId, callback) {
        const file = event.target.files[0];
        const preview = document.getElementById(previewId);
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                preview.src = e.target.result;
                preview.style.display = 'block';
                callback(e.target.result);
            };
            reader.readAsDataURL(file);
        } else {
            preview.style.display = 'none';
            callback(null);
        }
    }

    // === ã€é‡è¦ã€‘ãƒã‚°ä¿®æ­£: scoreTesté–¢æ•°ã‚’JSONãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”¨ã«å¤‰æ›´ ===
    async function scoreTest() {
        const questionsText = document.getElementById('test-questions-text').value;
        const studentAnswers = document.getElementById('student-answers').value;
        const resultArea = document.getElementById('result-area');
        const resultP = document.getElementById('scoring-result');
        const scoreButton = document.getElementById('score-button');

        if (!studentImageDataUrl) {
            alert('æ¡ç‚¹ã™ã‚‹ã«ã¯ã€å¿…ãšã€Œç”Ÿå¾’ã®ãƒ†ã‚¹ãƒˆç”»åƒã€ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚');
            return;
        }

        resultArea.style.display = 'block';
        resultP.textContent = 'AIå…ˆç”ŸãŒç”»åƒã‚’èª­ã¿å–ã£ã¦æ¡ç‚¹ä¸­ã§ã™...ï¼ˆå°‘ã—æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™ï¼‰';
        scoreButton.disabled = true;
        scoreButton.textContent = 'æ¡ç‚¹ä¸­...';
        lastGradingResult = ""; 
        document.getElementById('scoring-chat-area').style.display = 'none';
        document.getElementById('scoring-chat-log').innerHTML = '';

        try {
            const response = await fetch('/score_test', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    questions_text: questionsText,
                    student_image_url: studentImageDataUrl,
                    model_answer_image_url: modelAnswerImageDataUrl,
                    answers: studentAnswers 
                })
            });

            // ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ã§ã¯ãªãã€JSONã¨ã—ã¦ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ãƒ‘ãƒ¼ã‚¹
            const result = await response.json();

            if (response.ok) {
                // æˆåŠŸã—ãŸå ´åˆ
                lastGradingResult = result.full_text;
                resultP.textContent = lastGradingResult;
                document.getElementById('scoring-chat-area').style.display = 'block';
            } else {
                // ã‚µãƒ¼ãƒãƒ¼å´ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆ (app.pyã‹ã‚‰jsonify({"error": ...}) ãŒè¿”ã•ã‚ŒãŸå ´åˆ)
                lastGradingResult = `ã‚¨ãƒ©ãƒ¼: ${result.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`;
                resultP.textContent = lastGradingResult;
            }

        } catch (error) {
            // ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãªã©ã€fetchè‡ªä½“ãŒå¤±æ•—ã—ãŸå ´åˆ
            console.error("Fetch error:", error);
            lastGradingResult = "æ¡ç‚¹ã‚µãƒ¼ãƒãƒ¼ã¨ã®é€šä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
            resultP.textContent = lastGradingResult;
        }

        // èª­ã¿è¾¼ã¿ä¸­ã ã£ãŸãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
        scoreButton.disabled = false;
        scoreButton.textContent = 'æ¡ç‚¹ã‚’é–‹å§‹ã™ã‚‹';
    }
    // === ä¿®æ­£ã“ã“ã¾ã§ ===

    async function sendScoringQuestion() {
        const questionInput = document.getElementById('scoring-question');
        const chatLog = document.getElementById('scoring-chat-log');
        const question = questionInput.value;
        if (!question.trim()) return;

        appendScoringMessage(question, 'user-message');
        questionInput.value = '';

        const modelMessageDiv = appendScoringMessage('è€ƒãˆä¸­...', 'model-message');

        const response = await fetch('/ask_scoring', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                question: question,
                context: lastGradingResult // æ¡ç‚¹çµæœã®å…¨ãƒ†ã‚­ã‚¹ãƒˆã‚’æ–‡è„ˆã¨ã—ã¦æ¸¡ã™
            })
        });

        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        modelMessageDiv.textContent = '';

        while (true) {
            const { value, done } = await reader.read();
            if (done) break;
            const textChunk = decoder.decode(value, { stream: true });
            modelMessageDiv.textContent += textChunk;
            chatLog.scrollTop = chatLog.scrollHeight;
        }
    }

    function appendScoringMessage(text, className) {
        const chatLog = document.getElementById('scoring-chat-log');
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message', className);
        messageDiv.textContent = text;
        chatLog.appendChild(messageDiv);
        chatLog.scrollTop = chatLog.scrollHeight;
        return messageDiv;
    }
</script>
</body>
</html>