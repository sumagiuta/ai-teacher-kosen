{% extends "layout.html" %}

{% block content %}
<div class="grid md:grid-cols-3 gap-8">
    <div class="md:col-span-1">
        <div class="bg-white p-6 rounded-lg shadow-sm border border-slate-200 sticky top-24">
            <h3 class="text-lg font-bold mb-4 text-indigo-600 border-b pb-2">æ–°è¦èª²é¡Œã®ä½œæˆ</h3>
            <form action="/create_assignment" method="post" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-slate-700">ç§‘ç›®ãƒ»ã‚¿ã‚¤ãƒˆãƒ«</label>
                    <input type="text" name="title" placeholder="ä¾‹: ç·šå½¢ä»£æ•° ç¬¬3å›" required
                        class="mt-1 block w-full border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm border p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700">å­¦ç¿’å†…å®¹ã®æŒ‡ç¤º (AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ)</label>
                    <textarea name="description" rows="5" placeholder="ä¾‹: å›ºæœ‰å€¤ã¨å›ºæœ‰ãƒ™ã‚¯ãƒˆãƒ«ã®å¹¾ä½•å­¦çš„æ„å‘³ã«ã¤ã„ã¦ã€å·¥å­¦çš„å¿œç”¨ä¾‹ï¼ˆæŒ¯å‹•è§£æãªã©ï¼‰ã‚’äº¤ãˆã¦è§£èª¬ã—ã¦ã€‚" required
                        class="mt-1 block w-full border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm border p-2"></textarea>
                    <p class="text-xs text-slate-500 mt-1">AIå…ˆç”Ÿã¯ã“ã®æŒ‡ç¤ºã«åŸºã¥ã„ã¦æˆæ¥­ã‚’ç”Ÿæˆã—ã¾ã™ã€‚</p>
                </div>
                <button type="submit" class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 transition font-bold shadow">
                    èª²é¡Œã‚’ç™ºè¡Œã™ã‚‹
                </button>
            </form>
        </div>
    </div>

    <div class="md:col-span-2 space-y-8">
        
        <div>
            <h3 class="text-xl font-bold mb-4 text-slate-800">ç™ºè¡Œæ¸ˆã¿èª²é¡Œä¸€è¦§</h3>
            {% if assignments %}
                <div class="grid gap-4">
                    {% for assignment in assignments %}
                    <div class="bg-white p-5 rounded-lg shadow-sm border border-slate-200 hover:shadow-md transition">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="text-lg font-bold text-slate-800">{{ assignment.title }}</h4>
                                <p class="text-slate-600 text-sm mt-1">{{ assignment.description }}</p>
                            </div>
                            <span class="text-xs text-slate-400">{{ assignment.created_at.strftime('%Y-%m-%d') }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-slate-500 text-center py-10">ã¾ã èª²é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚å·¦ã®ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰ä½œæˆã—ã¦ãã ã•ã„ã€‚</p>
            {% endif %}
        </div>

        <div>
            <h3 class="text-xl font-bold mb-4 text-slate-800 flex items-center gap-2">
                ğŸ“Š æœ€æ–°ã®ç”Ÿå¾’ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ (è‡ªç”±å­¦ç¿’)
            </h3>
            {% if logs %}
            <div class="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">ç”Ÿå¾’</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">ç¨®é¡</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">å†…å®¹æ¦‚è¦</th>
                                <th class="px-4 py-3 text-left text-xs font-medium text-slate-500 uppercase">æ—¥æ™‚</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-slate-500 uppercase">è©³ç´°</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-slate-200">
                            {% for log in logs %}
                            <tr class="hover:bg-slate-50 transition">
                                <td class="px-4 py-4 whitespace-nowrap text-sm font-bold text-slate-800">
                                    {{ log.student.username }}
                                </td>
                                <td class="px-4 py-4 whitespace-nowrap text-sm">
                                    <span class="px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full {{ 'bg-purple-100 text-purple-800' if log.mode == 'problem' else 'bg-blue-100 text-blue-800' }}">
                                        {{ 'å•é¡Œæ¡ç‚¹' if log.mode == 'problem' else 'ãƒ¬ãƒãƒ¼ãƒˆ' }}
                                    </span>
                                </td>
                                <td class="px-4 py-4 text-sm text-slate-500 max-w-xs">
                                    <div class="flex items-center gap-2">
                                        {% if log.input_image %}
                                            <span class="text-xs bg-slate-100 border px-1 rounded">ğŸ“· ç”»åƒ</span>
                                        {% endif %}
                                        <span class="truncate w-32">{{ log.input_text or '(ãƒ†ã‚­ã‚¹ãƒˆãªã—)' }}</span>
                                    </div>
                                </td>
                                <td class="px-4 py-4 whitespace-nowrap text-xs text-slate-400">
                                    {{ log.created_at.strftime('%m/%d %H:%M') }}
                                </td>
                                <td class="px-4 py-4 text-center">
                                    <button onclick="openModal('{{ log.id }}')" class="text-indigo-600 hover:text-indigo-900 font-bold text-sm bg-indigo-50 px-3 py-1 rounded hover:bg-indigo-100 transition">
                                        è©³ç´°ã‚’è¦‹ã‚‹
                                    </button>
                                    
                                    <div id="data-{{ log.id }}" class="hidden">
                                        <div class="student-name">{{ log.student.username }}</div>
                                        <div class="mode-text">{{ 'å•é¡Œæ¡ç‚¹' if log.mode == 'problem' else 'ãƒ¬ãƒãƒ¼ãƒˆæ·»å‰Š' }}</div>
                                        <div class="date-text">{{ log.created_at.strftime('%Yå¹´%mæœˆ%dæ—¥ %H:%M') }}</div>
                                        <div class="input-text">{{ log.input_text }}</div>
                                        <div class="input-image">{{ log.input_image or '' }}</div>
                                        <div class="feedback-full">{{ log.feedback_content }}</div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% else %}
                <div class="bg-slate-50 rounded-lg p-6 text-center text-slate-500">
                    ã¾ã å­¦ç¿’å±¥æ­´ãŒã‚ã‚Šã¾ã›ã‚“ã€‚
                </div>
            {% endif %}
        </div>
    </div>
</div>

<div id="detailModal" class="fixed inset-0 z-[100] hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
    <div class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm transition-opacity" onclick="closeModal()"></div>

    <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
        <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
            <div class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-4xl max-h-[90vh] flex flex-col">
                
                <div class="bg-indigo-600 px-4 py-3 sm:px-6 flex justify-between items-center shrink-0">
                    <h3 class="text-base font-bold leading-6 text-white" id="modal-title">ğŸ“ å­¦ç¿’è©³ç´°ãƒ­ã‚°</h3>
                    <button onclick="closeModal()" class="text-indigo-200 hover:text-white transition text-2xl font-bold">&times;</button>
                </div>

                <div class="px-4 py-5 sm:p-6 overflow-y-auto custom-scrollbar flex-grow">
                    <div class="grid md:grid-cols-2 gap-6">
                        <div class="space-y-4">
                            <div class="border-b pb-2 mb-2">
                                <span id="modal-student" class="font-bold text-lg text-slate-800 mr-2"></span>
                                <span id="modal-mode" class="text-xs font-bold px-2 py-1 rounded bg-slate-200 text-slate-700"></span>
                                <p id="modal-date" class="text-xs text-slate-500 mt-1"></p>
                            </div>

                            <div>
                                <h4 class="text-sm font-bold text-slate-500 mb-2">ğŸ“¤ ç”Ÿå¾’ã®æå‡ºå†…å®¹</h4>
                                <div id="modal-input-image-area" class="mb-4 hidden">
                                    <img id="modal-input-image" src="" class="w-full rounded-lg border border-slate-200 object-contain max-h-64 bg-slate-50">
                                </div>
                                <div id="modal-input-text" class="p-3 bg-slate-50 rounded border border-slate-200 text-sm whitespace-pre-wrap font-mono text-slate-700 max-h-60 overflow-y-auto"></div>
                            </div>
                        </div>

                        <div class="flex flex-col h-full">
                            <h4 class="text-sm font-bold text-indigo-600 mb-2 flex justify-between items-center">
                                ğŸ¤– AIå…ˆç”Ÿã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯
                                <button onclick="speakModalContent()" class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded hover:bg-indigo-200">ğŸ”Š èª­ã¿ä¸Šã’</button>
                            </h4>
                            <div id="modal-feedback" class="flex-grow p-4 bg-indigo-50/50 rounded-lg border border-indigo-100 prose prose-sm prose-indigo max-w-none overflow-y-auto max-h-[60vh]">
                                </div>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-50 px-4 py-3 sm:flex sm:flex-row-reverse sm:px-6 shrink-0 border-t border-slate-200">
                    <button type="button" class="mt-3 inline-flex w-full justify-center rounded-md bg-white px-3 py-2 text-sm font-semibold text-slate-900 shadow-sm ring-1 ring-inset ring-slate-300 hover:bg-slate-50 sm:mt-0 sm:w-auto" onclick="closeModal()">é–‰ã˜ã‚‹</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let currentFeedbackText = "";

    function openModal(id) {
        const dataDiv = document.getElementById(`data-${id}`);
        
        // ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        const student = dataDiv.querySelector('.student-name').innerText;
        const mode = dataDiv.querySelector('.mode-text').innerText;
        const date = dataDiv.querySelector('.date-text').innerText;
        const inputText = dataDiv.querySelector('.input-text').innerText;
        const inputImage = dataDiv.querySelector('.input-image').innerText;
        const feedback = dataDiv.querySelector('.feedback-full').innerText;

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã«ã‚»ãƒƒãƒˆ
        document.getElementById('modal-student').innerText = student;
        document.getElementById('modal-mode').innerText = mode;
        document.getElementById('modal-date').innerText = date;
        document.getElementById('modal-input-text').innerText = inputText || "(ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ãªã—)";
        
        const imgArea = document.getElementById('modal-input-image-area');
        const imgTag = document.getElementById('modal-input-image');
        if (inputImage) {
            imgTag.src = inputImage;
            imgArea.classList.remove('hidden');
        } else {
            imgTag.src = "";
            imgArea.classList.add('hidden');
        }

        // Markdownã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        const feedbackArea = document.getElementById('modal-feedback');
        feedbackArea.innerHTML = marked.parse(feedback);
        currentFeedbackText = feedback; // èª­ã¿ä¸Šã’ç”¨ä¿å­˜

        // æ•°å¼ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚° (KaTeX)
        if (typeof renderMathInElement === 'function') {
            renderMathInElement(feedbackArea, {
                delimiters: [{left: '$$', right: '$$', display: true}, {left: '$', right: '$', display: false}]
            });
        }

        // è¡¨ç¤º
        document.getElementById('detailModal').classList.remove('hidden');
        document.body.style.overflow = 'hidden'; // èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å›ºå®š
    }

    function closeModal() {
        document.getElementById('detailModal').classList.add('hidden');
        document.body.style.overflow = 'auto'; // èƒŒæ™¯ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«è§£é™¤
        window.speechSynthesis.cancel(); // èª­ã¿ä¸Šã’åœæ­¢
    }

    function speakModalContent() {
        if(currentFeedbackText) speakText(currentFeedbackText);
    }
    
    // ESCã‚­ãƒ¼ã§é–‰ã˜ã‚‹
    document.addEventListener('keydown', function(event) {
        if (event.key === "Escape") {
            closeModal();
        }
    });
</script>
{% endblock %}